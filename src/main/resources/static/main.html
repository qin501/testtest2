<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>聊天室</title>
<!-- 最新版本的 Bootstrap 核心 CSS 文件 -->
<!--<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css"
integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"/>-->
<link rel="stylesheet" href="./css/bootstrap.min.css">
<link rel="stylesheet" href="css/amazeui.min.css" />
<link rel="stylesheet" href="css/main.css" />
<link rel="stylesheet" type="text/css" href="css/font-awesome.4.6.0.css">
<link rel="stylesheet" href="css/amazeui.cropper.css">
<link rel="stylesheet" href="./css/jquery-bigic.css">
<link rel="stylesheet" href="./css/ImgCropping.css">
<link rel="stylesheet" href="css/cropper.min.css">
<script type="text/javascript" charset="utf-8" src="ueditor.config.js"></script>
<script type="text/javascript" charset="utf-8" src="ueditor.all.min.js"></script>
<!--建议手动加在语言，避免在ie下有时因为加载语言失败导致编辑器加载失败-->
<!--这里加载的语言文件会覆盖你在配置项目里添加的语言类型，比如你在配置项目里配置的是英文，这里加载的中文，那最后就是中文-->
<script type="text/javascript" charset="utf-8" src="./js/zh-cn.js"></script>
<style>
	.am-dropdown-content {
	    width: 250px;
	    margin-left: 20px;
	    border: none;
	    border-radius: 4px;
	    box-shadow: 0 0 8px rgba(0,0,0,.1);
	    padding:20px 5px -1px 20px; //上 右 下 左
	    top: 0px;
	    left: 32px;
	}
	
	.up-img-cover {
		width: 100px;
		height: 100px;
	}
	
	.up-img-cover img{
		width: 100%;
	}
	
	.red-point{
      position: relative;
    }

    .red-point::before{
      content: " ";
      border: 3px solid #C9394A;/*设置红色*/
      border-radius:5px;/*设置圆角*/
      position: absolute;
      z-index: 3000;
      right: 0%;
      margin-right: -10px;
      margin-top: 0px;
    }
	.user_text img{
		width: 20px;
		height: 20px;
	}
	.user_text video{
		width: 20px;
		height: 20px;
	}
	.talk_window #talk_window_chat video{
		width: 120px;
		height: 120px;
	}
    #talk_window_chat span p{
       padding: 0px;
       margin-top: 0px;
    }
</style>
</head>
<body>
<div class="box">
	<div class="wechat">
		
		<div class="sidestrip">
			<div class="am-dropdown" data-am-dropdown>
				<!--头像-->
				<div  id="ownhead" class="own_head am-dropdown-toggle"></div>
				<div class="am-dropdown-content">
					<div class="own_head_top">
						<div class="own_head_top_text">
							<p id="own_name" class="own_name"></p>
							<p id="own_numb" class="own_numb"></p>
						</div>
						<img id="img_head"  alt="" />
					</div>
					<div class="own_head_bottom">
						
						<div class="own_head_bottom_img">
							<a href="javascript:void(0)"><img src="image/icon/head_1.png"/></a>
							<!--<a href="#"><img src="image/icon/head_2.png"/></a>-->
						</div>
					</div>
				</div>
			</div>
			<!--三图标-->
			<div class="sidestrip_icon">
				<a id="si_1" style="background: url(image/icon/head_2_1.png) no-repeat;" ></a>
				<a id="si_2" ></a>

			</div>
			
			<!--底部扩展键-->
			<div id="doc-dropdown-justify-js">
				<div class="am-dropdown" id="doc-dropdown-js" style="position: initial;">
					<div class="sidestrip_bc am-dropdown-toggle"></div>
					<ul class="am-dropdown-content" id = "extend_nick">
						<li itemId="one">							
						 <a href="#"  data-am-modal="{target: '#doc-modal-1', closeViaDimmer: 0, width: 400, height: 180}">添加好友</a>
						 <div class="am-modal am-modal-no-btn" tabindex="-1" id="doc-modal-1">
						  <div class="am-modal-dialog">
							<div class="am-modal-hd">添加好友
							  <a href="javascript: void(0)" class="am-close am-close-spin" data-am-modal-close>&times;</a>
							</div>
							
							<div class="am-modal-bd">
							  <div class="modal-body">
									<div class="form-group">										
										<input type="text" name="txt_departmentname" class="form-control" id="add_newname" placeholder="好友ID">
										<input type="text" id="addh_newname" value="" style="display:none"></input>
									</div>
									<!--<div class="form-group">										
										<input type="text" name="txt_parentdepartment" class="form-control" id="add_comfirm" placeholder="备注">
										<input type="text" value="" id="addh_comfirm" style="display:none"></input>
									</div>-->
			
									<div class="modal-footer">
										<button type="button" id="add_submit" class="btn btn-primary" data-dismiss="modal" data-am-modal-close>确认</button>
										<button type="button" id="add_cancel" class="btn btn-default" data-dismiss="modal"  data-am-modal-close>取消</button>
										
									</div>
								</div>
							  </div>
						  	</div>
						  </div>
						</li>
						
						<li itemId="two">
							<a href="#"  data-am-modal="{target: '#doc-modal-2', closeViaDimmer: 0, width: 400, height: 180}">修改呢称</a>		
							<div class="am-modal am-modal-no-btn" tabindex="-1" id="doc-modal-2">
							  <div class="am-modal-dialog">
								<div class="am-modal-hd">修改呢称
								  <a href="javascript: void(0)" class="am-close am-close-spin" data-am-modal-close>&times;</a>
								</div>
								<div class="am-modal-bd">
									  <div class="modal-body">
										<div class="form-group">
											<input type="text" name="txt_departmentname" class="form-control" id="txt_newname" placeholder="新的呢称">
										</div>
										<div class="form-group">
											<div class="modal-footer">
												<button type="button" id="nick_submit" class="btn btn-primary" data-dismiss="modal" data-am-modal-close>确认</button>
												<button type="button" id="nick_cancel"class="btn btn-default" data-dismiss="modal"  data-am-modal-close>取消</button>
											</div>
										</div>
									  </div>
								</div>
							  </div>
							</div>
						</li>
						
						<!--<li itemId="thr">
							<a href="#"  data-am-modal="{target: '#doc-modal-3', closeViaDimmer: 0, width: 400, height: 170}">修改头像</a>
							<div class="am-modal am-modal-no-btn" tabindex="-1" id="doc-modal-3">
							    <div class="am-modal-dialog">
								    <div class="am-modal-hd">开始上传新的头像
								      <a href="javascript: void(0)" class="am-close am-close-spin" data-am-modal-close>&times;</a>
								    </div>
								    <div class="am-form-group" >
								      <input  for="doc-ipt-file-1" type="file" id="doc-ipt-file-1">
								      <p class="am-form-help">请选择要上传的文件...</p>
								    </div>
									<div class="modal-footer">
										<button type="button" id="img_submit" class="btn btn-primary" data-dismiss="modal" data-am-modal-close>确认</button>
										<button type="button" id="img_cancel"class="btn btn-default" data-dismiss="modal"  data-am-modal-close>取消</button>
									</div>
							    </div>
							</div>
						</li>-->

						<li itemId="thrr">
							<a href="javascript:void(0)" onclick="showReplaceImg()">修改头像</a>
						</li>

						
						<li itemId="fou">
							<a href="#"  data-am-modal="{target: '#doc-modal-4', closeViaDimmer: 0, width: 400, height: 170}">退出</a>
							<div class="am-modal am-modal-no-btn" tabindex="-1" id="doc-modal-4">
							    <div class="am-modal-dialog">
								    <div class="am-modal-hd">确定退出？
								      <a href="javascript: void(0)" class="am-close am-close-spin" data-am-modal-close>&times;</a>
								    </div>
								    <div class="form-group">										
										<input type="text" style="visibility: hidden;" class="form-control"  placeholder="占位">
									</div>
									<div class="modal-footer">
										<button type="button" id="exit_submit" class="btn btn-primary" data-dismiss="modal" data-am-modal-close>确认</button>
										<button type="button" id="exit_cancel"class="btn btn-default" data-dismiss="modal"  data-am-modal-close>取消</button>
										
									</div>
	    
							    </div> 
							</div>
						</li>
					</ul>
				</div>	
			</div>	
		</div>
		    
		<!--聊天列表-->
		<div class="middle on">
			<div class="wx_search">
				<input type="text" placeholder="搜索暂不支持"/>
				<button type="button" >+</button>

			</div>
			
			<div class="office_text">
				<ul class="user_list"  id = "friendlist">
					<!--<li class="user_active" friendUserId="1809287G8NPDF0SW">
						<div class="user_head"><img src="image/head/15.jpg"/></div>
						<div class="user_text">
							<p class="user_name">早安无恙</p>
							<p class="user_message">我是傻逼！，牛逼！</p>
						</div>
						<div class="user_time">下午 2：54</div>
					</li>					-->
				</ul>
			</div>	
		</div>
		
		<!--好友列表-->
		<div class="middle">
			<div class="wx_search">
				<input type="text" placeholder="搜索暂不支持"/>
				<button>+</button>

			</div>
			
			<div class="office_text">
				<ul class="friends_list" id ="contactList" >
<!--					<li class="friends_box">

						<p>好友列表</p>
					</li>

					<li class="friends_box" friendUserId="office_text1">						
						<div class="user_head"><img src="image/head/3.jpg"/></div>
						<div class="friends_text">
							<p class="user_name">丶plus</p>
						</div>
					</li>
-->
				</ul>
			</div>	
		</div>
		
		<!--通过好友请求-->
		<div class="am-modal am-modal-no-btn" tabindex="-1" id="chat-modal-5">
		    <div class="am-modal-dialog">
			    <div class="am-modal-hd">是否通过好友请求? 
			      <a href="javascript: void(0)" class="am-close am-close-spin" data-am-modal-close>&times;</a>
			      
			    </div>
			
				<div class="modal-footer">
					<input type="text" value="" id="sendUserId_comfirm" style="display:none"></input>
					<button type="button" id="req_submit" class="btn btn-primary" data-dismiss="modal" data-am-modal-close>通过</button>
					<button type="button" id="req_cancel"class="btn btn-default" data-dismiss="modal"  data-am-modal-close>拒绝</button>
				</div>
			    	    
		    </div> 
		</div>
		<!--重复登录警告框-->
		<div class="am-modal am-modal-no-btn" tabindex="-1" id="chat-modal-7">
			<div class="am-modal-dialog"> 
				<div class="am-modal-hd"> 用户在其他地方登录
				 	<a href="javascript: void(0)" class="am-close am-close-spin" data-am-modal-close> &times;</a>		      
				</div> 
				
				<div class="modal-footer">
					<input type="text" value="" id="sendUserId_comfirm1" style="display:none"> </input>
					<button type="button" id="alert_submit" class="btn btn-primary" data-dismiss="modal" data-am-modal-close>确定</button> 		
				</div>		
			</div>
		</div>
		
		
		<!--发送添加好友请求-->
		<div class="am-modal am-modal-no-btn" tabindex="-1" id="chat-modal-6">
			
		    <div class="am-modal-dialog">
			    <div class="am-modal-hd">确认添加好友
			      <a href="javascript: void(0)" class="am-close am-close-spin" data-am-modal-close>&times;</a>
			    </div>
				<div class="am-modal-bd">
				  <div class="modal-body">
						<div class="friends_box" id="con_chat">
							<!--<div class="user_head"><img src="image/head/3.jpg"/></div>
							<div class="friends_text">
								<p class="user_name">彭于晏丶plus</p>
							</div>-->
						</div>

						<div class="modal-footer">
							<button type="button" id="addh_submit" class="btn btn-primary" data-dismiss="modal" data-am-modal-close>确认</button>
							<button type="button" id="addh_cancel" class="btn btn-default" data-dismiss="modal"  data-am-modal-close>取消</button>
							
						</div>
					</div>
				  </div>
			    	    
		    </div> 
		</div>
		<!--程序列表-->
		<div class="middle">
			<div class="wx_search">
				<input type="text" placeholder="搜索收藏内容"/>
				<button>+</button>
			</div>
			<div class="office_text">
			</div>	
		</div>
	
		<!--聊天窗口-->				
		<div  class="talk_window" >

			<ul id="talk_window_chat">

			</ul>
			<!--保存上一个窗口的信息-->
			<input type="text" id="talk_hiden" value="" style="display:none"></input>  
		</div>
	</div>
</div>

<!-- jQuery -->
<!--<script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>-->
<script src="./js/jquery.min.js"></script>
<script type="text/javascript" src="js/amazeui.min.js"></script>
<script type="text/javascript" src="js/zUI.js"></script>
<script type="text/javascript" src="js/wechat.js"></script>
<script src="js/app.js"></script>
<script src="js/contact.js"></script>
<script type="text/javascript" src="js/nickname.js" ></script>
<script src="js/cropper.min.js" charset="utf-8"></script>
<script type="text/javascript" src="js/chat.js"></script>
<script type="text/javascript" src="./js/jquery-bigic.js"></script>
<script>
    $(function () {
        $('img').bigic();
    })
</script>
<script type="text/javascript">
	$(function () {
        UE.Editor.prototype._bkGetActionUrl = UE.Editor.prototype.getActionUrl;
        UE.Editor.prototype.getActionUrl = function(action) {
            if (action == 'uploadimage' || action == 'uploadscrawl' || action == 'uploadimage') {
                return 'uploadImage';
            }else if(action=='uploadvideo'){
				return '../../uploadImage';
			} else {
                return this._bkGetActionUrl.call(this, action);
            }
        };
        //加载头像
        flashhead();
    });
	window.onload=function(){
		function init(){
			var me = app.getUserGlobalInfo();
			console.log(me);
			if(!app.isNotNull(me)){
				alert("请先登录");
				app.userLogout();
				return;
			}
			contact.fetchContactList();
			contact.fetchFriendRequests();
			setTimeout("contact.renderChatPage()", "1000");
			setTimeout("contact.renderContactPage()", "1000");
//			CHAT.init();
			setTimeout("CHAT.init()", "1000");
			var si1 = document.getElementById('si_1');
			var si2 = document.getElementById('si_2');
			si1.onclick=function(){
				si1.style.background="url(image/icon/head_2_1.png) no-repeat"
				si2.style.background="";
				changeChatbox();
			};
			
			si2.onclick=function(){
				si2.style.background="url(image/icon/head_3_1.png) no-repeat"
				si1.style.background="";
				changeChatbox();
				contact.fetchContactList();
				contact.fetchFriendRequests();
				contact.renderContactPage();
				contact.renderChatPage();
			};
		};
		init();
	};
	//聊天点击弹出
	$("ul.user_list").on("click","li",function(){     
		var friendUserId = this.getAttribute("friendUserId");
//	     console.log("聊天点击弹出: "+friendUserId);
		var me = app.getUserGlobalInfo();
		app.readUserChatSnapshot(me.id,friendUserId);
	    CHAT.loadingChatSnapshot();
	    
	     //渲染聊天页面
 		setChatPage(friendUserId);
 		
		changeChatbox(friendUserId);

        $('img').bigic();
	});	
		
		
	// 为好友通讯录批量绑定点击事件
	$("#contactList").on("click", ".chat-with-friend", function(){
		var friendUserId = this.getAttribute("friendUserId");
		var flag = this.getAttribute("flag");
		//处理好友请求
		if(!app.isNotNull(flag)) {
			$('#chat-modal-5').modal();
			document.getElementById('sendUserId_comfirm').value = friendUserId;
			return;
		}
		//聊天窗口滑到最下
		var scroll_div = document.getElementById("scroll_div_" + friendUserId);
		scroll_div.scrollTop = scroll_div.scrollHeight;
		// 打开聊天子页面	
		changeChatbox(friendUserId);
		//渲染聊天页面
		setChatPage(friendUserId);
	});
	
	//渲染聊天页面
	function setChatPage(friendUserId){
		
		var chatbox =  document.getElementById("chatbox_" + friendUserId);
		if(!app.isNotNull(chatbox)){
//			console.log("ttt");
			contact.fetchContactList();
			contact.fetchFriendRequests();
			contact.renderContactPage();
			contact.renderChatPage();
			chatbox =  document.getElementById("chatbox_" + friendUserId);
		}
//		console.log("chatbox: " + chatbox);
		var me = app.getUserGlobalInfo();
		var fd = app.getFriendFromContactList(friendUserId);
		var chatHistory = app.getUserChatHistory(me.id,friendUserId);
		var th = '';
		for(var i=0 ; i < chatHistory.length ; i++){
			var ch = chatHistory[i];
			if(ch.flag == 1){
				th += '<li class="me"><img src="'+ app.imgServerUrl + me.faceImageBig +'"><span>'+ ch.msg +'</span></li>';
			}else{
				th += '<li class="other"><img src="'+app.imgServerUrl + fd.friendFaceImage+'"><span>'+ ch.msg +'</span></li>';
			}
		}
	    chatbox.innerHTML = th;
		var scroll_div = document.getElementById("scroll_div_" + friendUserId); 
		scroll_div.scrollTop = scroll_div.scrollHeight;
        $('img').bigic();
	}
	
	
	
	//刷新图像
	function flashhead() {
		var user = app.getUserGlobalInfo();
		var ut = 'url(' + app.imgServerUrl + user.faceImageBig +')';
//		console.log("head: " + ut);
		$('#ownhead').css("background-image",ut);
		$('#own_name').text("昵称  ：" + user.nickname);  
		$('#own_numb').text("用户ID ：" + user.username); 
		$('#img_head').attr('src',app.imgServerUrl + user.faceImageBig);
		
//		console.log("昵称  ：" + user.nickname);
	}
	
	
	//关闭其他聊天窗口
	function changeChatbox(txt_new) {
		
		var txt = document.getElementById("talk_hiden").value;

		if(app.isNotNull(txt)){
			document.getElementById(txt).style.display="none";
			document.getElementById("talk_hiden").value = null;
		}
		
		if(app.isNotNull(txt_new)){
			document.getElementById(txt_new).style.display="";
			document.getElementById("talk_hiden").value = txt_new;

		}
		
	}

	var doClick = function(){
			
//			console.log("触发了点击事件： "+document.getElementById("talk_hiden").value);
			
			var id = document.getElementById("talk_hiden").value;
			var text = document.getElementById("input_box_" + id);
			var UU=UE.getEditor("input_box_" + id);
			//console.log("发送的内容："+UU.getContent());

			text.value=UU.getContent();
        	//var text = document.getElementById("chatmsg" + id);
			var chat = document.getElementById("chatbox_" + id);
			var talk = document.getElementById("talkbox_" + id);
			
			
			var me = app.getUserGlobalInfo();
			//180930F1BPBMYSA8
			if(text.value ==''){
				alert('不能发送空消息');
			}else{
				chat.innerHTML += '<li class="me"><img src="'+ app.imgServerUrl + me.faceImageBig +'"><span>'+ text.value +'</span></li>';
				
				//输入窗口滑到最下
				chat.scrollTop=chat.scrollHeight;
				talk.style.background="#fff";
				text.style.background="#fff";
				//聊天窗口滑到最下
				var scroll_div = document.getElementById("scroll_div_" + id);
				scroll_div.scrollTop = scroll_div.scrollHeight;
				
				//发送消息到数据库
				// 构建ChatMsg
				var chatMsg = new app.ChatMsg(me.id, id, text.value, null);
				// 构建DataContent
				var dataContent = new app.DataContent(app.CHAT, chatMsg, null);
				
				CHAT.chat(JSON.stringify(dataContent));
				app.saveUserChatHistory(me.id, id,text.value, 1);
				app.saveUserChatSnapshot(me.id, id, text.value, true);
				
				CHAT.loadingChatSnapshot();
				//最后再清空输入框
				text.value = '';
				UU.setContent('');
			};
        $('img').bigic();
			
		};
	 
	 
	//查找好友信息
	$("#add_submit").click(function () {
//		console.log("查找好友信息");
		var txt_newname = document.getElementById("add_newname").value;
//		var txt_comfirm = document.getElementById("add_comfirm").value;
		document.getElementById('addh_newname').value = txt_newname;
		
		$('.form-control').val("");
		var user = app.getUserGlobalInfo();			
		$.ajax({
			url:app.serverUrl + "/u/search?myUserId=" + user.id +"&friendUsername=" + txt_newname, 
			data:{},
			dataType:'json',//服务器返回json格式数据
			type:'post',//HTTP请求类型
			timeout:10000,//超时时间设置为10秒；
			headers:{'Content-Type':'application/json'},	              
			success:function(data){
				//服务器返回响应
			
				if (data.status == 200) {
					var userInfoJson = data.data;
					var ut = app.imgServerUrl + userInfoJson.faceImageBig;
//					console.log(userInfoJson);
					var innerHtml = ' <div class="user_head"> <img src="'+ ut +'"/></div> ' +
									' <div class="user_text"> ' +
										' <p class="user_name"> 昵称： ' + txt_newname +' </p> ' +
										' <p class="user_message">用户名：  ' +  userInfoJson.username +'</p> ' +
									' </div> ';
					
					
					$('#con_chat').html(innerHtml);
					$('#chat-modal-6').modal();
					
				} else {
					alert(data.msg);
				}
			}
		});
	}); 
	
	//发送添加好友请求
	$("#addh_submit").click(function () {
//		console.log("发送添加好友请求");
		var txt_newname = document.getElementById("addh_newname").value;
		//var txt_comfirm = document.getElementById("addh_comfirm").value;
//		console.log(txt_newname);

		var user = app.getUserGlobalInfo();	
		$.ajax( {
			url: app.serverUrl + "/u/addFriendRequest?myUserId=" + user.id + "&friendUsername=" + txt_newname,
			data:{},
			dataType:'json',//服务器返回json格式数据
			type:'post',//HTTP请求类型
			timeout:100000,//超时时间设置为10秒；
			headers:{'Content-Type':'application/json'},	              
			success:function(data){
				//服务器返回响应
			
				if (data.status == 200) {

//					console.log("添加成功");
				} else {
					alert(data.msg);
				}
			}
		});

	}); 
	 
	 //通过好友请求 
	$("#req_submit").click(function () {
//		console.log("通过好友请求");
		var sendUserId = document.getElementById('sendUserId_comfirm').value;
		var user = app.getUserGlobalInfo();	
//		console.log(sendUserId);
		
		operatorFriendRequest(user.id, sendUserId, 1);

	});
	
	//拒绝好友请求
	$("#req_cancel").click(function () {
		
//		console.log("拒绝好友请求");
		var sendUserId = document.getElementById('sendUserId_comfirm').value;
		var user = app.getUserGlobalInfo();	
//		console.log(sendUserId);
		
		operatorFriendRequest(user.id, sendUserId, 0);
		
	});
	 
	//修改呢称提交
	$("#nick_submit").click(function () {

        var txt_newname = document.getElementById("txt_newname").value;
//      console.log(txt_newname);
	    $('.form-control').val(""); 
	    var user = app.getUserGlobalInfo();	
	    
        $.ajax({
        	url:app.serverUrl + "/u/setNickname",
			data:JSON.stringify({
				userId: user.id, 
				nickname: txt_newname
			}),			
			dataType:'json',//服务器返回json格式数据
			type:'post',//HTTP请求类型
			timeout:10000,//超时时间设置为10秒；
			headers:{'Content-Type':'application/json'},	              
			success:function(data){
				//服务器返回响应，根据响应结果，分析是否登录成功；

				
				if (data.status == 200) {
					// 登录或者注册成功之后，保存全局用户对象到本地缓存
//					console.log("更新成功");
					var userInfoJson = data.data;
					app.setUserGlobalInfo(userInfoJson);
					

				} else {
					alert(data.msg);
				}
			}
		});

	});
	//修改呢称取消
	$("#nick_cancel").click(function () {
 
 		$('.form-control').val("");

	});	
	
	//头像上传
	$("#img_submit").click(function () {
        var e = document.getElementById("doc-ipt-file-1").files[0];
        if(!app.isNotNull(e)){
        	 alert("请选择图片");
       		 return;
        }

        var user = app.getUserGlobalInfo();	

        var reader = new FileReader();
		reader.onload = function ( event ) { 
            var base64Url = event.target.result;  //转为base64字符串
//          console.log(user.id);
            $.ajax({
            	url:app.serverUrl + "/u/uploadFaceBase64",
				data:JSON.stringify({
					userId: user.id, //
					faceData: base64Url
				}),
				
				dataType:'json',//服务器返回json格式数据
				type:'post',//HTTP请求类型
				timeout:10000,//超时时间设置为10秒；
				headers:{'Content-Type':'application/json'},	              
				success:function(data){
					//服务器返回响应，根据响应结果，分析是否登录成功；
					if (data.status == 200) {
						// 登录或者注册成功之后，保存全局用户对象到本地缓存
//						console.log("更新成功");
						var userInfoJson = data.data;
						app.setUserGlobalInfo(userInfoJson);
//						window.location.reload();
						flashhead();
					} else {
						alert(data.msg);
					}
				}
			});
        };
	    reader.readAsDataURL(e);
	});

	//用户退出
	$("#exit_submit").click(function () {
		
		app.userLogout();		

	});
	
	//用户退出
	$("#alert_submit").click(function () {
		console.log("okok");
		app.userLogout();		

	});
	
	// 操作好友请求
	function operatorFriendRequest(userId, friendId, operType) {
		$.ajax({
			url:app.serverUrl + "/u/operFriendRequest?acceptUserId=" + userId
										+ "&sendUserId=" + friendId
										+ "&operType=" + operType,
			data:{},
			dataType:'json',//服务器返回json格式数据
			type:'post',//HTTP请求类型
			timeout:10000,//超时时间设置为10秒；
			headers:{'Content-Type':'application/json'},	              
			success:function(data){
				
				// 更新通讯录
				var myFriendList = data.data;
				app.setContactList(myFriendList);
				
				// 重新加载
				contact.fetchContactList();
				contact.fetchFriendRequests();
				contact.renderContactPage();
				contact.renderChatPage();
				location.reload() ;
			}
		});
	}
	
</script>

<!--图片裁剪框 start-->
<div style="display: none;" class="tailoring-container">
	<div class="black-cloth" onclick="closeTailor(this)"></div>
	<div class="tailoring-content">
		<div class="tailoring-content-one">
			<label title="上传图片" for="chooseImg" class="l-btn choose-btn">
				<input type="file" accept="image/jpg,image/jpeg,image/png" name="file" id="chooseImg" class="hidden" onchange="selectImg(this)">
				选择头像
			</label>
			<div class="close-tailoring"  onclick="closeTailor(this)">×</div>
		</div>
		<div class="tailoring-content-two">
			<div class="tailoring-box-parcel">
				<img id="tailoringImg">
			</div>
			<div class="preview-box-parcel">
				<p>头像预览：</p>
				<div class="square previewImg"></div>
				<div class="circular previewImg"></div>
			</div>
		</div>
		<div class="tailoring-content-three">
			<button class="l-btn cropper-reset-btn">还原</button>
			<button class="l-btn cropper-rotate-btn">旋转</button>
			<button class="l-btn cropper-scaleX-btn">换向</button>
			<button class="l-btn sureCut" id="sureCut">确定</button>
		</div>
	</div>
</div>
<!--图片裁剪框 end-->
<div style="width: 320px;height: 320px;border: solid 1px #555;padding: 5px;margin-top: 10px;display: none;">
	<img id="finalImg" src="" width="100%">
</div>
<script type="text/javascript" src="./js/cropper.min.js"></script>
<script type="text/javascript">
    $(function () {
        //弹出框水平垂直居中
        (window.onresize = function () {
            var win_height = $(window).height();
            var win_width = $(window).width();
            if (win_width <= 768){
                $(".tailoring-content").css({
                    "top": (win_height - $(".tailoring-content").outerHeight())/2,
                    "left": 0
                });
            }else{
                $(".tailoring-content").css({
                    "top": (win_height - $(".tailoring-content").outerHeight())/2,
                    "left": (win_width - $(".tailoring-content").outerWidth())/2
                });
            }
        })();
        //cropper图片裁剪
        $('#tailoringImg').cropper({
            aspectRatio: 1/1,//默认比例
            preview: '.previewImg',//预览视图
            guides: false,  //裁剪框的虚线(九宫格)
            autoCropArea: 0.5,  //0-1之间的数值，定义自动剪裁区域的大小，默认0.8
            movable: false, //是否允许移动图片
            dragCrop: true,  //是否允许移除当前的剪裁框，并通过拖动来新建一个剪裁框区域
            movable: true,  //是否允许移动剪裁框
            resizable: true,  //是否允许改变裁剪框的大小
            zoomable: false,  //是否允许缩放图片大小
            mouseWheelZoom: false,  //是否允许通过鼠标滚轮来缩放图片
            touchDragZoom: true,  //是否允许通过触摸移动来缩放图片
            rotatable: true,  //是否允许旋转图片
            crop: function(e) {
                // 输出结果数据裁剪图像。
            }
        });
        //旋转
        $(".cropper-rotate-btn").on("click",function () {
            $('#tailoringImg').cropper("rotate", 45);
        });
        //复位
        $(".cropper-reset-btn").on("click",function () {
            $('#tailoringImg').cropper("reset");
        });
        //换向
        var flagX = true;
        $(".cropper-scaleX-btn").on("click",function () {
            if(flagX){
                $('#tailoringImg').cropper("scaleX", -1);
                flagX = false;
            }else{
                $('#tailoringImg').cropper("scaleX", 1);
                flagX = true;
            }
            flagX != flagX;
        });

        //裁剪后的处理
        $("#sureCut").on("click",function () {
            if ($("#tailoringImg").attr("src") == null ){
                return false;
            }else{
                var cas = $('#tailoringImg').cropper('getCroppedCanvas');//获取被裁剪后的canvas
                var base64url = cas.toDataURL('image/png'); //转换为base64地址形式

				var user=app.getUserGlobalInfo();
               $.ajax({
                  url:app.serverUrl+"/u/uploadFaceBase64",
                  data:JSON.stringify({
                        userId:user.id,
                        faceData:base64url
                  }),
                  type:"post",
                  dataType:'json',
				   timeout:10000,
                   headers:{'Content-Type':'application/json'},
                   success:function (data) {
                       if(data.status==200){
                           var userInfoJson = data.data;
                           app.setUserGlobalInfo(userInfoJson);
                           flashhead();
                       }else{
                           alert(data.msg);
                       }

                   }
               });
               // $("#finalImg").prop("src",base64url);//显示为图片的形式
                //关闭裁剪框
                closeTailor();
            }
        });
    });
    //弹出图片裁剪框
	function showReplaceImg(){
        $(".tailoring-container").toggle();
	}
/*    $("#replaceImg").on("click",function () {
        //方法切换元素的可见状态
        $(".tailoring-container").toggle();
    });*/
    //选中图像
    function selectImg(file) {
        if (!file.files || !file.files[0]){
            return;
        }
        var reader = new FileReader();
        reader.onload = function (evt) {
            var replaceSrc = evt.target.result;
            //更换cropper的图片
            $('#tailoringImg').cropper('replace', replaceSrc,false);//默认false，适应高度，不失真
        }
        reader.readAsDataURL(file.files[0]);
    }
    //关闭裁剪框
    function closeTailor() {
        $(".tailoring-container").toggle();
    }
</script>

</body>
</html>